name: Deploy to Azure Dev Subscription

on:
  workflow_dispatch
  # push:
  #   branches:
  #     - main

env:
  DOCKER_IMAGE_NAME: genai-chatbnt  

jobs:
  build-and-deploy:
    runs-on: LargerGitHubRunner4Core150GB

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - uses: azure/login@a65d910e8af852a8061c627c456678983e180302
      with:
        creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL_DEPLOYMENT_CREDS }}

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Build frontend
      run: npm run frontend

    - name: Build app as a Docker image
      run: |
        image_name="$DOCKER_IMAGE_NAME:${{ github.sha }}"
        docker build -t $image_name --label "branch=${{ github.ref }}" --label "commit=${{ github.sha }}" .

    - name: Push the image to Azure Container Registry and tag as latest
      run: |
        echo "Logging into Azure Container Registry acrchatbntdev"
        az acr login --name acrchatbntdev
        image_name="$DOCKER_IMAGE_NAME:${{ github.sha }}"
        docker push $image_name
        docker tag $image_name "$DOCKER_IMAGE_NAME:latest"
        docker push "$DOCKER_IMAGE_NAME:latest"
    
    - name: logout
      run: |
        az logout
